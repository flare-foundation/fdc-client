package attestation_test

import (
	"flare-common/database"
	"flare-common/policy"
	"fmt"
	"local/fdc/client/attestation"
	"math/big"

	"testing"

	"github.com/ethereum/go-ethereum/common"
	"github.com/stretchr/testify/require"
)

func TestSkipDuplicates(t *testing.T) {

	tests := []struct {
		toAdd    []common.Hash
		atTheEnd []common.Hash
	}{
		{
			toAdd:    []common.Hash{common.HexToHash("1"), common.HexToHash("1"), common.HexToHash("2")},
			atTheEnd: []common.Hash{common.HexToHash("1"), common.HexToHash("2")},
		},
		{
			toAdd:    []common.Hash{},
			atTheEnd: []common.Hash{},
		},

		{
			toAdd:    []common.Hash{common.HexToHash("1")},
			atTheEnd: []common.Hash{common.HexToHash("1")},
		},

		{
			toAdd:    []common.Hash{common.HexToHash("2"), common.HexToHash("1")},
			atTheEnd: []common.Hash{common.HexToHash("2"), common.HexToHash("1")},
		},
		{
			toAdd:    []common.Hash{common.HexToHash("2"), common.HexToHash("1"), common.HexToHash("2")},
			atTheEnd: []common.Hash{common.HexToHash("2"), common.HexToHash("1")},
		},
	}

	for i, test := range tests {

		hashes := []common.Hash{}

		added := attestation.CheckList{}

		for j := range test.toAdd {

			hashes = attestation.SkipDuplicates(added, test.toAdd[j], hashes)
		}

		require.Equal(t, test.atTheEnd, hashes, fmt.Sprintf("error in test %d", i))

	}

}

func TestAddAttestation(t *testing.T) {

	tests := []struct {
		requests         []database.Log
		fees             []*big.Int
		added            []bool
		nuOfAttestations int
	}{
		{
			requests: []database.Log{
				{
					Address:         "Cf6798810Bc8C0B803121405Fee2A5a9cc0CA5E5",
					Data:            "0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000014045564d5472616e73616374696f6e00000000000000000000000000000000000045544800000000000000000000000000000000000000000000000000000000005453e040c1d33d8852f82714b28959380834b66988fa0348efe38625b3320b4500000000000000000000000000000000000000000000000000000000000000204ff8da95da542ca5e013daf405d08871fdb4375ee6dec77f001e918c8cd8d1b800000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000",
					Topic0:          "251377668af6553101c9bb094ba89c0c536783e005e203625e6cd57345918cc9",
					Topic1:          "NULL",
					Topic2:          "NULL",
					Topic3:          "NULL",
					TransactionHash: "e995790cdbb02e851cd767ee4f36bdf4d172b6fc210a497a505ec9c73330f5d1",
					LogIndex:        0,
					Timestamp:       1718113234,
					BlockNumber:     16497501,
				},
				{
					Address:         "Cf6798810Bc8C0B803121405Fee2A5a9cc0CA5E5",
					Data:            "0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000014045564d5472616e73616374696f6e00000000000000000000000000000000000045544800000000000000000000000000000000000000000000000000000000005453e040c1d33d8852f82714b28959380834b66988fa0348efe38625b3320b4500000000000000000000000000000000000000000000000000000000000000204ff8da95da542ca5e013daf405d08871fdb4375ee6dec77f001e918c8cd8d1b800000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000",
					Topic0:          "251377668af6553101c9bb094ba89c0c536783e005e203625e6cd57345918cc9",
					Topic1:          "NULL",
					Topic2:          "NULL",
					Topic3:          "NULL",
					TransactionHash: "e995790cdbb02e851cd767ee4f36bdf4d172b6fc210a497a505ec9c73330f5d1",
					LogIndex:        1,
					Timestamp:       1718113234,
					BlockNumber:     16497501,
				},
			},
			fees:             []*big.Int{big.NewInt(20)},
			added:            []bool{true, false},
			nuOfAttestations: 1,
		},
		{
			requests: []database.Log{
				{
					Address:         "Cf6798810Bc8C0B803121405Fee2A5a9cc0CA5E5",
					Data:            "0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000014045564d5472616e73616374696f6e00000000000000000000000000000000000045544800000000000000000000000000000000000000000000000000000000005453e040c1d33d8852f82714b28959380834b66988fa0348efe38625b3320b4500000000000000000000000000000000000000000000000000000000000000204ff8da95da542ca5e013daf405d08871fdb4375ee6dec77f001e918c8cd8d1b800000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000",
					Topic0:          "251377668af6553101c9bb094ba89c0c536783e005e203625e6cd57345918cc9",
					Topic1:          "NULL",
					Topic2:          "NULL",
					Topic3:          "NULL",
					TransactionHash: "e995790cdbb02e851cd767ee4f36bdf4d172b6fc210a497a505ec9c73330f5d1",
					LogIndex:        0,
					Timestamp:       1718113234,
					BlockNumber:     16497501,
				},
				{
					Address:         "Cf6798810Bc8C0B803121405Fee2A5a9cc0CA5E5",
					Data:            "0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000014045564d5472616e73616374696f6e00000000000000000000000000000000000045544800000000000000000000000000000000000000000000000000000000007ed203ed1fc0fab440d0f120a78bbbef3664b4798979c1c17f66b2102c5e7a970000000000000000000000000000000000000000000000000000000000000020cffebff81f4bee3c0aa9f96e84319969b01a04bcbca3df57090db867126ce55500000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000",
					Topic0:          "251377668af6553101c9bb094ba89c0c536783e005e203625e6cd57345918cc9",
					Topic1:          "NULL",
					Topic2:          "NULL",
					Topic3:          "NULL",
					TransactionHash: "0b8ae3462ce8226b9abeb660d70c842170ae60f4118d2b9401cbc89162395728",
					LogIndex:        0,
					Timestamp:       1718113235,
					BlockNumber:     16497501,
				},
			},
			fees:             []*big.Int{big.NewInt(10), big.NewInt(10)},
			added:            []bool{true, true},
			nuOfAttestations: 2,
		},
		{
			requests: []database.Log{
				{
					Address:         "Cf6798810Bc8C0B803121405Fee2A5a9cc0CA5E5",
					Data:            "0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000014045564d5472616e73616374696f6e00000000000000000000000000000000000045544800000000000000000000000000000000000000000000000000000000005453e040c1d33d8852f82714b28959380834b66988fa0348efe38625b3320b4500000000000000000000000000000000000000000000000000000000000000204ff8da95da542ca5e013daf405d08871fdb4375ee6dec77f001e918c8cd8d1b800000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000",
					Topic0:          "251377668af6553101c9bb094ba89c0c536783e005e203625e6cd57345918cc9",
					Topic1:          "NULL",
					Topic2:          "NULL",
					Topic3:          "NULL",
					TransactionHash: "e995790cdbb02e851cd767ee4f36bdf4d172b6fc210a497a505ec9c73330f5d1",
					LogIndex:        1,
					Timestamp:       1718113234,
					BlockNumber:     16497501,
				},
				{
					Address:         "Cf6798810Bc8C0B803121405Fee2A5a9cc0CA5E5",
					Data:            "0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000014045564d5472616e73616374696f6e00000000000000000000000000000000000045544800000000000000000000000000000000000000000000000000000000007ed203ed1fc0fab440d0f120a78bbbef3664b4798979c1c17f66b2102c5e7a970000000000000000000000000000000000000000000000000000000000000020cffebff81f4bee3c0aa9f96e84319969b01a04bcbca3df57090db867126ce55500000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000",
					Topic0:          "251377668af6553101c9bb094ba89c0c536783e005e203625e6cd57345918cc9",
					Topic1:          "NULL",
					Topic2:          "NULL",
					Topic3:          "NULL",
					TransactionHash: "0b8ae3462ce8226b9abeb660d70c842170ae60f4118d2b9401cbc89162395728",
					LogIndex:        0,
					Timestamp:       1718113235,
					BlockNumber:     16497501,
				},
				{
					Address:         "Cf6798810Bc8C0B803121405Fee2A5a9cc0CA5E5",
					Data:            "0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000014045564d5472616e73616374696f6e00000000000000000000000000000000000045544800000000000000000000000000000000000000000000000000000000005453e040c1d33d8852f82714b28959380834b66988fa0348efe38625b3320b4500000000000000000000000000000000000000000000000000000000000000204ff8da95da542ca5e013daf405d08871fdb4375ee6dec77f001e918c8cd8d1b800000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000",
					Topic0:          "251377668af6553101c9bb094ba89c0c536783e005e203625e6cd57345918cc9",
					Topic1:          "NULL",
					Topic2:          "NULL",
					Topic3:          "NULL",
					TransactionHash: "e995790cdbb02e851cd767ee4f36bdf4d172b6fc210a497a505ec9c73330f5d1",
					LogIndex:        0,
					Timestamp:       1718113234,
					BlockNumber:     16497501,
				},
			},
			fees:             []*big.Int{big.NewInt(20), big.NewInt(10)},
			added:            []bool{true, true, false},
			nuOfAttestations: 2,
		},
	}

	for i, test := range tests {

		round := attestation.CreateRound(1, policy.NewVoterSet(nil, nil))

		for j, request := range test.requests {
			att, err := attestation.AttestationFromDatabaseLog(request)

			require.NoError(t, err, fmt.Sprintf("error parsing request %d in test %d ", j, i))

			added := attestation.AddAttestation(round, &att)

			require.Equal(t, test.added[j], added, fmt.Sprintf("wrongly added request %d in test %d ", j, i))

		}

		require.Equal(t, test.nuOfAttestations, len(round.Attestations), fmt.Sprintf("wrong number of attestations in test %d", i))

		for j, att := range round.Attestations {

			require.Equal(t, test.fees[j], att.Fee, fmt.Sprintf("wrong fee for attestation %d in test %d", j, i))
		}
	}

}
